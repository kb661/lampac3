name: Build Lampac

on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x
      
      - name: Build
        run: |
          chmod +x build.sh
          ./build.sh
      
      - name: Create release package
        run: |
          cd publish
          zip -r ../lampac-full.zip .
          cd ..
      
      - uses: actions/upload-artifact@v4
        with:
          name: lampac-full
          path: lampac-full.zip        
          echo "  Module: $(basename "$dll")"
    else
        cp "$dll" ./publish/module/references/ 2>/dev/null || true
    fi
done

# === ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ wwwroot Ð¸Ð· Ð¼Ð¾Ð´ÑƒÐ»ÐµÐ¹ ===
echo "Copying module wwwroot files..."
if [ -d "module" ]; then
    find module -path "*/wwwroot/*" -type f | while read file; do
        target="./publish/${file}"
        mkdir -p "$(dirname "$target")"
        cp "$file" "$target"
        echo "  UI: ${file}"
    done
fi

# === ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ ÐºÐ¾Ð½Ñ„Ð¸Ð³Ð¸ Ð¸ ÑÐºÑ€Ð¸Ð¿Ñ‚Ñ‹ ===
echo "Copying configuration files..."
cp init.conf ./publish/ 2>/dev/null || echo "init.conf not found"
cp init.yaml ./publish/ 2>/dev/null || echo "init.yaml not found"
cp install.sh ./publish/ 2>/dev/null || echo "install.sh not found"
cp update.sh ./publish/ 2>/dev/null || echo "update.sh not found"

# === Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ README ÐµÑÐ»Ð¸ Ð½ÐµÑ‚ ===
echo "Creating README.txt..."
cat > ./publish/README.txt << EOF
Lampac - ÑÐ¾Ð±Ñ€Ð°Ð½Ð½Ð°Ñ Ð²ÐµÑ€ÑÐ¸Ñ

Ð—Ð°Ð¿ÑƒÑÐº:
  dotnet Lampac.dll

ÐŸÐ¾ÑÐ»Ðµ Ð·Ð°Ð¿ÑƒÑÐºÐ° Ð¸Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹Ñ Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ Ð¿Ð¾ Ð°Ð´Ñ€ÐµÑÑƒ:
  http://localhost:9118
EOF

echo ""
echo "âœ… Build completed successfully!"
echo "ðŸ“ Output: ./publish"
echo ""
echo "ðŸ“Š Statistics:"
echo "  DLL files: $(find ./publish -name "*.dll" | wc -l)"
echo "  JS files:  $(find ./publish -name "*.js" | wc -l)"
echo "  CSS files: $(find ./publish -name "*.css" | wc -l)"
