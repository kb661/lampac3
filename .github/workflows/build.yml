set -e

echo "Building Lampac project with all modules..."

# Clean previous builds
rm -rf ./publish ./bin ./obj

# Restore and build
dotnet restore Lampac.sln
dotnet build Lampac.sln --configuration Release --no-restore

# Publish main app
dotnet publish Lampac/Lampac.csproj \
  --configuration Release \
  --output ./publish \
  --no-build

# === Ð’ÐÐ–ÐÐž: ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ wwwroot (Ð²ÐµÐ±-Ð¸Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹Ñ) ===
echo "Copying wwwroot files..."
if [ -d "Lampac/wwwroot" ]; then
    mkdir -p ./publish/wwwroot
    cp -r Lampac/wwwroot/* ./publish/wwwroot/
    echo "âœ“ wwwroot copied"
else
    echo "âš  Lampac/wwwroot not found"
fi

# === ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ð¼Ð¾Ð´ÑƒÐ»Ð¸ ===
echo "Setting up modules..."
mkdir -p ./publish/module/references

# Copy module DLLs
find . -name "*.dll" -path "*/bin/Release/*" \
  -not -path "*/publish/*" \
  -not -name "Lampac.dll" \
  -not -name "Microsoft.*" \
  -not -name "System.*" | while read dll; do
    
    if [[ "$dll" == *"/module/"* ]] || [[ "$dll" == *"/Modules/"* ]]; then
        cp "$dll" ./publish/module/ 2>/dev/null || true
        echo "  Module: $(basename "$dll")"
    else
        cp "$dll" ./publish/module/references/ 2>/dev/null || true
    fi
done

# === ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ wwwroot Ð¸Ð· Ð¼Ð¾Ð´ÑƒÐ»ÐµÐ¹ ===
echo "Copying module wwwroot files..."
if [ -d "module" ]; then
    find module -path "*/wwwroot/*" -type f | while read file; do
        target="./publish/${file}"
        mkdir -p "$(dirname "$target")"
        cp "$file" "$target"
        echo "  UI: ${file}"
    done
fi

# === ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ ÐºÐ¾Ð½Ñ„Ð¸Ð³Ð¸ Ð¸ ÑÐºÑ€Ð¸Ð¿Ñ‚Ñ‹ ===
echo "Copying configuration files..."
cp init.conf ./publish/ 2>/dev/null || echo "init.conf not found"
cp init.yaml ./publish/ 2>/dev/null || echo "init.yaml not found"
cp install.sh ./publish/ 2>/dev/null || echo "install.sh not found"
cp update.sh ./publish/ 2>/dev/null || echo "update.sh not found"

# === Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ README ÐµÑÐ»Ð¸ Ð½ÐµÑ‚ ===
echo "Creating README.txt..."
cat > ./publish/README.txt << EOF
Lampac - ÑÐ¾Ð±Ñ€Ð°Ð½Ð½Ð°Ñ Ð²ÐµÑ€ÑÐ¸Ñ

Ð—Ð°Ð¿ÑƒÑÐº:
  dotnet Lampac.dll

ÐŸÐ¾ÑÐ»Ðµ Ð·Ð°Ð¿ÑƒÑÐºÐ° Ð¸Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹Ñ Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ Ð¿Ð¾ Ð°Ð´Ñ€ÐµÑÑƒ:
  http://localhost:9118
EOF

echo ""
echo "âœ… Build completed successfully!"
echo "ðŸ“ Output: ./publish"
echo ""
echo "ðŸ“Š Statistics:"
echo "  DLL files: $(find ./publish -name "*.dll" | wc -l)"
echo "  JS files:  $(find ./publish -name "*.js" | wc -l)"
echo "  CSS files: $(find ./publish -name "*.css" | wc -l)"
